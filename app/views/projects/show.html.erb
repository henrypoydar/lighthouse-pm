<% throw_content :javascripts do %>
$(document).ready(function() {
	$(".edit").editable("/tickets/update", {
		indicator : "Saving...",
		tooltip   : 'Click to edit...',
		id        : 'ticket_id'
	});
<% milestone_count = @project.milestones.size %>
<% for i in 0..( milestone_count - 1 ) %>
	$("#milestone_<%= i %>").sortable({ 
	    connectWith: [<%= (0..(milestone_count - 1)).to_a.reject { |j| j == i }.map { |m| "\"#milestone_#{m}\""}.join(',') %>]
	}); 
<% end %>
});
<% end %>

<div style='float: right'>
<p><a href="">Update totals</a></p>
</div>

<h1>Project: <span class='identifier'><%= @project.name %></span></h1>
<p><small><%= pluralize_with_count_display @project.milestones.size, 'milestone' %>, <%= pluralize_with_count_display @project.open_tickets_count, 'open ticket' %></small></p>

<table class="totals">
	<tr><td>Estimate for all open tickets: </td><td align="right"><b><%= @project.time_totals[:open][:estimated] %></b> days</td></tr>
	<tr><td>Estimate for all closed tickets: </td><td align="right"><b><%= @project.time_totals[:closed][:estimated] %></b> days</td></tr>
	<tr><td>Actual for all closed tickets: </td><td align="right"><b><%= @project.time_totals[:closed][:estimated] %></b> days</td></tr>
</table>


<% @project.milestones.each do |milestone| %>
<hr />
<div class="milestone">
	<h2>Milestone: <span class='identifier'><%= milestone.title %></span></h2>
	<p><small><%= pluralize_with_count_display @project.open_tickets_by_milestone( milestone ).size, 'open ticket' %></small></p>
	<ul id="milestone_<%= milestone.index %>" class="tickets">	
	<% @project.tickets_by_milestone( milestone ).each do |ticket| %>
		<li class="<%= ticket.state%> <%= "untimed" if ticket.untimed %>">
			<a href="http://<%= Merb::Config[:lighthouse]['project_settings']['account_name'] %>.lighthouseapp.com/projects/<%= Merb::Config[:lighthouse]['project_settings']['project_id'] %>/tickets/<%= ticket.number %>" target="_lighthouse"><img src="/images/external.png", alt="link out" /></a>
			<span class="edit" id="<%= ticket.number %>" style="display:inline-block;"><%= ticket.title %></span>
			<span class="assigned_to" style="float:right;"><%= ticket.assigned_to_name %></span>
		</li>
	<% end %>	
	</ul>
	<table class="totals">
		<tr><td>Estimate for open tickets: </td><td align="right"><b><%= @project.time_totals_by_milestone( milestone)[:open][:estimated] %></b> days</td></tr>
		<tr><td>Estimate for closed tickets: </td><td align="right"><b><%= @project.time_totals_by_milestone( milestone)[:closed][:estimated] %></b> days</td></tr>
		<tr><td>Actual for closed tickets: </td><td align="right"><b><%= @project.time_totals_by_milestone( milestone)[:closed][:estimated] %></b> days</td></tr>
	</table>
</div>
<% end %>

<hr />
<p><small><span class="untimed">Red tickets</span> were not able to be parsed for time estimates</small></p>
